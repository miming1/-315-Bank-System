<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deposit Account</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="header">
      <h2>BankSys</h2>
      <i class="hamburger" id="hamburger">&#9776;</i>
    </div>
    <ul>
      <li id="home"><i>üè†</i> <span>Dashboard</span></li>
      <li id="historyNav"><i>üìú</i> <span>Transaction History</span></li>
      <li id="profile"><i>‚öôÔ∏è</i> <span>Profile Settings</span></li>
      <li id="notifications"><i>üîî</i> <span>Notifications</span></li>
      <li id="logout"><i>üö™</i> <span>Logout</span></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <h1>Deposit Account</h1>

    <!-- Balance -->
    <div class="balance-container">
      <p>Balance: ‚Ç±<span id="depositBalance">0.00</span></p>
      <p id="depositAccountId" class="subtext" style="font-weight: lighter; color: dimgray; font-size: 15px;"></p>
      <p id="depositAccountStatus" class="subtext" style="font-weight: lighter; color: dodgerblue; font-size: 15px;"></p>
    </div>

    <!-- Go Back -->
    <div style="display: flex; justify-content: right;">
      <button class="button" id="goBackBtn" style="display:none;">Go Back</button>
    </div>

    <!-- Subtype tiles -->
    <div class="dashboard subtype-dashboard" id="subtypeTiles">
      <div class="card account-card account-open" id="depositTile">
        <h3>Deposit</h3>
        <p>Place funds into your account for safe keeping and future use.</p>
      </div>
      <div class="card account-card account-open" id="withdrawTile">
        <h3>Withdraw</h3>
        <p>Take funds out of your account for personal or business use.</p>
      </div>
      <div class="card account-card account-open" id="transferTile">
        <h3>Transfer</h3>
        <p>Move funds securely between your accounts or to another user.</p>
      </div>
      <div class="card account-card account-open" id="historyTile">
        <h3>Transaction History</h3>
        <p>View all your deposit transactions.</p>
      </div>
    </div>

    <!-- Freeze button -->
    <div style="display: flex; justify-content: right; margin-top:12px;">
      <button class="button" id="freezeBtn" style="background-color: dodgerblue;">Freeze Account</button>
    </div>

    <!-- Form container -->
    <div style="display: flex; justify-content: center; margin-top:18px;">
      <div class="form" id="formContainer" style="display:none;"></div>
    </div>

    <!-- Transaction Table -->
    <div id="transactionContainer" style="margin-top:20px; display:none;">
      <div id="depositMessage" class="message"></div>
      <table id="depositTransactionTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Recipient / Reason</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal -->
    <div class="modal" id="accountModal">
      <div class="modal-content">
        <span class="modal-close" id="modalClose">&times;</span>
        <p id="accountMessage"></p>
        <div id="modalActions" style="margin-top:20px; text-align:center;"></div>
      </div>
    </div>
  </div>

    <script>
        function normalizeClientObject(raw) {
            if (!raw || typeof raw !== 'object') return {};
            return {
                user_id: raw.user_id || raw.id || null,
                full_name: raw.full_name || raw.fullName || raw.name || null,
                email: raw.email || raw.emailAddress || null,

                deposit_type_id: raw.deposit_type_id || raw.depositTypeId || raw.depositType || null,
                deposit_balance: raw.deposit_balance !== undefined ? raw.deposit_balance : (raw.depositBalance !== undefined ? raw.depositBalance : 0),

                savings_type_id: raw.savings_type_id || raw.savingsTypeId || null,
                savings_balance: raw.savings_balance !== undefined ? raw.savings_balance : (raw.savingsBalance !== undefined ? raw.savingsBalance : 0),

                loan_type_id: raw.loan_type_id || raw.loanTypeId || null,
                loan_balance: raw.loan_balance !== undefined ? raw.loan_balance : (raw.loanBalance !== undefined ? raw.loanBalance : 0),

                ...raw
            };
        }

        let _rawClient = JSON.parse(localStorage.getItem('clientData')) || {};
        let clientData = normalizeClientObject(_rawClient);
        const clientToken = localStorage.getItem('clientToken') || '';
        const clientId = clientData?.user_id || null;

        function saveClientData(updated) {
            const normalized = normalizeClientObject(updated);
            localStorage.setItem('clientData', JSON.stringify(normalized));
            clientData = normalized;
        }

        const sidebar = document.getElementById('sidebar');
        const hamburger = document.getElementById('hamburger');
        const modal = document.getElementById('accountModal');
        const modalClose = document.getElementById('modalClose');
        const accountMessage = document.getElementById('accountMessage');
        const modalActions = document.getElementById('modalActions');

        const formContainer = document.getElementById('formContainer');
        const subtypeTiles = document.getElementById('subtypeTiles');
        const depositBalance = document.getElementById('depositBalance');
        const depositAccountStatus = document.getElementById('depositAccountStatus');
        const goBackBtn = document.getElementById('goBackBtn');
        const freezeBtn = document.getElementById('freezeBtn');
        const transactionContainer = document.getElementById('transactionContainer');
        const depositMessage = document.getElementById('depositMessage');

        modalClose.addEventListener('click', () => modal.classList.remove('active'));
        function showModal(message, actionsHTML = '') {
            accountMessage.innerHTML = message;
            modalActions.innerHTML = actionsHTML;
            modal.classList.add('active');
        }

        async function fetchClientAccounts() {
            try {
                const res = await fetch('/api/client/accounts', {
                    headers: { 'Authorization': `Bearer ${clientToken}` }
                });
                if (!res.ok) throw new Error('Failed to fetch accounts');
                const accounts = await res.json();

                const depositAcc = accounts.find(acc => acc.type_name === 'Deposit');
                if (depositAcc) {
                    clientData.deposit_type_id = depositAcc.type_id;
                    clientData.deposit_balance = depositAcc.balance;
                    clientData.deposit_status = depositAcc.account_status;
                }

                saveClientData(clientData);

                depositBalance.textContent = parseFloat(clientData.deposit_balance).toFixed(2);
                document.getElementById("depositAccountId").textContent = `Account ID: ${clientData.deposit_type_id}`;
                depositAccountStatus.textContent = `Status: ${clientData.deposit_status}`;

                updateFreezeButton();

            } catch (err) {
                console.error('Fetch accounts error:', err);
                showModal('Could not fetch account info. Please log in again.');
            }
        }

        function updateFreezeButton() {
            const status = clientData.deposit_status || 'Active';

            switch (status) {
                case 'Active':
                    freezeBtn.textContent = 'Freeze Account';
                    freezeBtn.disabled = false;
                    break;

                case 'Frozen':
                    freezeBtn.textContent = 'Unfreeze Account';
                    freezeBtn.disabled = false;
                    break;

                case 'pending_freeze':
                case 'Pending Freeze':
                    freezeBtn.textContent = 'Freeze Pending...';
                    freezeBtn.disabled = true;
                    break;

                case 'pending_unfreeze':
                case 'Pending Unfreeze':
                    freezeBtn.textContent = 'Unfreeze Pending...';
                    freezeBtn.disabled = true;
                    break;

                default:
                    freezeBtn.textContent = 'Freeze Account';
                    freezeBtn.disabled = false;
            }

            depositAccountStatus.textContent = `Status: ${status}`;
        }


        async function updateFreezeStatus() {
            if (!clientData.deposit_type_id) {
                return showModal('Account type not found.');
            }

            const current = clientData.deposit_status;
            let action;

            // Decide whether to freeze or unfreeze
            if (current === 'Active') {
                action = 'freeze';
            } else if (current === 'Frozen') {
                action = 'unfreeze';
            } else {
                return showModal('Account request is already pending.');
            }

            try {
                const res = await fetch(`/api/client/account/${clientData.deposit_type_id}/${action}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${clientToken}` }
                });

                const data = await res.json();

                if (!res.ok) {
                    return showModal(data.message || 'Unable to update status.');
                }

                // Update UI with pending status
                clientData.deposit_status = action === 'freeze'
                    ? 'Pending Freeze'
                    : 'Pending Unfreeze';

                saveClientData(clientData);
                updateFreezeButton();

                showModal(data.message);

            } catch (err) {
                console.error(err);
                showModal('Failed to update freeze status.');
            }
        }

        freezeBtn.addEventListener('click', updateFreezeStatus);

        hamburger.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
        document.getElementById('home').onclick = () => location.href = 'home.html';
        document.getElementById('historyNav').onclick = () => location.href = 'history.html';
        document.getElementById('profile').onclick = () => location.href = 'profile.html';
        document.getElementById('notifications').onclick = () => location.href = 'notifications.html';
        document.getElementById('logout').onclick = () => {
            localStorage.removeItem('clientToken');
            localStorage.removeItem('clientData');
            location.href = '../index.html';
        };
        document.getElementById('home').style.backgroundColor = 'var(--accent-color)';
        document.getElementById('home').style.color = '#000';

        async function postTransaction(url, data) {
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                if (!res.ok) throw new Error(json.message || 'Error');
                return json;
            } catch (err) {
                showModal(`Transaction failed: ${err.message}`);
                throw err;
            }
        }

        // --- Transaction subtypes logic (deposit/withdraw/transfer/history) ---
        const subtypes = [
            { id: 'depositTile', type: 'deposit', route: '/api/transactions/deposit' },
            { id: 'withdrawTile', type: 'withdraw', route: '/api/transactions/withdraw' },
            { id: 'transferTile', type: 'transfer', route: '/api/transactions/transfer' },
            { id: 'historyTile', type: 'history' }
        ];

        subtypes.forEach(sub => {
            const element = document.getElementById(sub.id);
            if (!element) return;

            element.onclick = async () => {
                if (!clientData.deposit_type_id) {
                    await fetchClientAccounts();
                    if (!clientData.deposit_type_id) return showModal('Account type not found.');
                }

                const typeId = clientData.deposit_type_id;

                if (sub.type === 'history') {
                    subtypeTiles.style.display = 'none';
                    formContainer.style.display = 'none';
                    transactionContainer.style.display = 'block';
                    goBackBtn.style.display = 'inline-block';
                    freezeBtn.style.display = 'none';
                    depositMessage.textContent = 'Fetching transactions...';

                    try {
                        const res = await fetch(`/api/transactions/history/account/Deposit`, {
                            headers: { 'Authorization': `Bearer ${clientToken}` }
                        });
                        const data = await res.json();
                        depositMessage.textContent = `Fetched ${data.length} transactions.`;

                        const tbody = document.querySelector("#depositTransactionTable tbody");
                        tbody.innerHTML = "";
                        data.forEach(tx => {
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${new Date(tx.transaction_date).toLocaleString()}</td>
                                <td>${tx.transaction_type}</td>
                                <td>‚Ç±${parseFloat(tx.amount).toFixed(2)}</td>
                                <td>${tx.description || '-'}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } catch (err) {
                        depositMessage.textContent = 'Failed to fetch transactions';
                        depositMessage.classList.add('error');
                    }

                } else {
                    let formHtml = `<form id="${sub.type}Form"><h2>${sub.type.charAt(0).toUpperCase() + sub.type.slice(1)} Money</h2>`;
                    if (sub.type === 'transfer') formHtml += `<input type="number" placeholder="Recipient Account ID" required>`;
                    formHtml += `<input type="number" placeholder="Amount" required>`;
                    formHtml += `<button type="submit">${sub.type.charAt(0).toUpperCase() + sub.type.slice(1)}</button></form>`;

                    formContainer.innerHTML = formHtml;
                    formContainer.style.display = 'block';
                    subtypeTiles.style.display = 'none';
                    transactionContainer.style.display = 'none';
                    freezeBtn.style.display = 'none';
                    goBackBtn.style.display = 'inline-block';

                    const formEl = document.getElementById(`${sub.type}Form`);
                    formEl.onsubmit = async e => {
                        e.preventDefault();

                        let amount, toTypeId;
                        if (sub.type === 'transfer') {
                            toTypeId = parseInt(e.target[0].value);
                            amount = parseFloat(e.target[1].value);
                        } else {
                            amount = parseFloat(e.target[0].value);
                        }

                        if (isNaN(amount) || amount <= 0) return showModal('Enter a valid amount.');

                        const payload = sub.type === 'transfer'
                            ? { fromTypeId: typeId, toTypeId, amount }
                            : { typeId, amount };

                        const result = await postTransaction(sub.route, payload);

                        if (result.newBalance !== undefined && result.newBalance !== null) {
                            clientData.deposit_balance = parseFloat(result.newBalance);
                        } else {
                            clientData.deposit_balance = sub.type === 'deposit'
                                ? (clientData.deposit_balance || 0) + amount
                                : (clientData.deposit_balance || 0) - amount;
                        }

                        depositBalance.textContent = parseFloat(clientData.deposit_balance).toFixed(2);
                        saveClientData(clientData);
                        await fetchClientAccounts();

                        if (sub.type === 'transfer') {
                            showModal(`Transfer of ‚Ç±${amount.toFixed(2)} successful.<br>Sent to Account ID: ${payload.toTypeId}.`);
                        } else {
                            showModal(`${sub.type.charAt(0).toUpperCase() + sub.type.slice(1)} of ‚Ç±${amount.toFixed(2)} successful.`);
                        }
                    };
                }
            };
        });

        goBackBtn.onclick = () => {
            formContainer.innerHTML = '';
            formContainer.style.display = 'none';
            transactionContainer.style.display = 'none';
            freezeBtn.style.display = 'inline-block';
            subtypeTiles.style.display = 'flex';
            goBackBtn.style.display = 'none';
        };

        fetchClientAccounts();
    </script>
</body>
</html>
