<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Loan Account - BankSys</title>
  <link rel="stylesheet" href="../style.css">

  <style>
    /* --- FORM LAYOUT IMPROVEMENTS --- */

    .loan-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      margin-top: 10px;
      max-width: 600px;
    }

    form label {
      font-weight: 600;
      margin-top: 12px;
      display: block;
    }

    form input,
    form select {
      width: 100%;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 6px;
      margin-top: 6px;
      font-size: 15px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    #loanSummary {
      max-width: 600px;
    }

    .button {
      padding: 10px 18px;
      background: #0070f3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 15px;
    }
    .button:disabled {
      background: gray;
      cursor: not-allowed;
    }

    /* Center main content better */
    .main-content {
      max-width: 800px;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <div class="sidebar" id="sidebar">
    <div class="header">
      <h2>BankSys</h2><i class="hamburger" id="hamburger">&#9776;</i>
    </div>
    <ul>
      <li id="home"><i>üè†</i> <span>Dashboard</span></li>
      <li id="history"><i>üìú</i> <span>Transaction History</span></li>
      <li id="profile"><i>‚öôÔ∏è</i> <span>Profile Settings</span></li>
      <li id="notifications"><i>üîî</i> <span>Notifications</span></li>
      <li id="logout"><i>üö™</i> <span>Logout</span></li>
    </ul>
  </div>

  <div class="main-content">
    <h1>Loan Services</h1>

    <!-- Active Loan Section -->
    <div id="activeLoanSection" class="loan-card" style="display:none;">
      <h2>Your Active Loan</h2>
      <p>Remaining Balance: ‚Ç±<span id="activeRemaining">0.00</span></p>
      <p>Next Payment: ‚Ç±<span id="activeMonthly">0.00</span></p>
      <p>Due Date: <span id="activeDue">-</span></p>
      <button class="button" id="payNowBtn">Pay Now</button>
    </div>

    <!-- Loan Form -->
    <div class="loan-card" id="loanFormContainer">
      <h2>Apply For a Loan</h2>
      <form id="loanForm">

        <label>Loan Amount (‚Ç±)</label>
        <input type="number" id="amount" required min="1000" step="0.01" oninput="validateForm()">

        <label>Loan Term (Months)</label>
        <select id="term" required oninput="validateForm()">
          <option value="3">3 Months</option>
          <option value="6">6 Months</option>
          <option value="12" selected>12 Months</option>
          <option value="24">24 Months</option>
        </select>

        <label>Monthly Income (‚Ç±)</label>
        <input type="number" id="income" required min="0" oninput="validateForm()">

        <label>Employment Status</label>
        <select id="employment" required>
          <option value="">Select</option>
          <option value="Employed">Employed</option>
          <option value="Self-Employed">Self-Employed</option>
          <option value="Freelancer">Freelancer</option>
          <option value="Unemployed">Unemployed</option>
        </select>

        <!-- NEW JOB POSITION DROPDOWN -->
        <label>Job Position</label>
        <select id="job_position" required>
          <option value="">Select Position</option>
          <option value="Business Owner">Business Owner</option>
          <option value="Field Worker">Field Worker</option>
          <option value="Freelancer">Freelancer</option>
          <option value="Manager">Manager</option>
          <option value="Office Staff">Office Staff</option>
          <option value="Technical Specialist">Technical Specialist</option>
          <option value="Student">Student</option>    
          <option value="Other">Other</option>
        </select>


        <label>Purpose of Loan</label>
        <input type="text" id="purpose" required oninput="validateForm()">

        <button type="button" class="button" id="calculateBtn" disabled>Calculate Loan</button>
      </form>
    </div>

    <!-- Summary -->
    <div id="loanSummary" class="loan-card" style="display:none;">
      <h2>Loan Summary</h2>
      <p>Max Loanable: ‚Ç±<span id="maxLoanable"></span></p>
      <p>Interest Rate (APR): <span id="summaryRate"></span>%</p>
      <p>Monthly Payment: ‚Ç±<span id="summaryMonthly"></span></p>

      <p id="eligibilityHint"></p>

      <button class="button" id="showTermsBtn">View Terms & Conditions</button>
    </div>

    <!-- History -->
    <h2 style="margin-top:40px;">Loan Applications History</h2>
    <table id="loanHistoryTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Amount</th>
          <th>Term</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Modal -->
    <div class="modal" id="loanModal">
      <div class="modal-content">
        <span class="modal-close" id="modalClose">&times;</span>
        <div id="modalBody"></div>
      </div>
    </div>
  </div>

<script>
  const apiBase = '/api/loan';
  const userId = localStorage.getItem('user_id') || 1;

  /* -----------------------
     REAL-TIME VALIDATION
  ------------------------ */
  function validateForm() {
    const amount = document.getElementById('amount').value;
    const term = document.getElementById('term').value;
    const income = document.getElementById('income').value;
    const employment = document.getElementById('employment').value;
    const purpose = document.getElementById('purpose').value;

    const isValid =
      amount > 0 &&
      term !== "" &&
      income > 0 &&
      employment !== "" &&
      purpose.trim() !== "";

    document.getElementById('calculateBtn').disabled = !isValid;
  }

  /* ----------------------
     (Your Existing Logic)
  ---------------------- */

  const modal = document.getElementById("loanModal");
  const modalClose = document.getElementById("modalClose");
  const modalBody = document.getElementById("modalBody");

  modalClose.onclick = () => modal.classList.remove('active');

  async function loadLoanData() {
    const eligResp = await fetch(`${apiBase}/eligibility/${userId}`);
    const elig = await eligResp.json();

    document.getElementById('eligibilityHint').textContent =
      `Combined Deposit+Savings: ‚Ç±${elig.combined.toFixed(2)} ‚Äî eligible tiers: ${elig.eligible_tiers.join(', ') || 'none'}`;

    if (elig.activeLoan) {
      document.getElementById("activeLoanSection").style.display = "block";
      document.getElementById("activeRemaining").textContent = Number(elig.activeLoan.remaining_balance).toFixed(2);
      document.getElementById("activeMonthly").textContent = Number(elig.activeLoan.monthly_payment).toFixed(2);
      document.getElementById("activeDue").textContent = elig.activeLoan.next_due || '-';
    }

    const statusResp = await fetch(`${apiBase}/status/${userId}`);
    const status = await statusResp.json();

    const tbody = document.querySelector('#loanHistoryTable tbody');
    tbody.innerHTML = '';

    status.history.forEach(app => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${app.application_date}</td>
        <td>‚Ç±${Number(app.loan_amount).toFixed(2)}</td>
        <td>${app.loan_term_months}</td>
        <td>${app.status}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  loadLoanData();

  document.getElementById('calculateBtn').addEventListener('click', async () => {
    const payload = {
      user_id: Number(userId),
      amount: Number(document.getElementById('amount').value),
      term_months: Number(document.getElementById('term').value),
      income: Number(document.getElementById('income').value),
      employment_status: document.getElementById('employment').value,
      job_title: document.getElementById('jobTitle').value,
      purpose: document.getElementById('purpose').value
    };

    const resp = await fetch(`${apiBase}/calculate`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await resp.json();
    if (!resp.ok) return alert("Error: " + data.error);

    document.getElementById('maxLoanable').textContent = Number(data.maxPrincipal).toFixed(2);
    document.getElementById('summaryRate').textContent = Number(data.interestRate).toFixed(2);
    document.getElementById('summaryMonthly').textContent = Number(data.monthlyForRequested).toFixed(2);

    document.getElementById('loanSummary').style.display = 'block';
  });

  document.getElementById('showTermsBtn').addEventListener('click', () => {
    const rate = document.getElementById('summaryRate').textContent;
    const monthly = document.getElementById('summaryMonthly').textContent;

    modalBody.innerHTML = `
      <h3>Terms & Conditions</h3>
      <p>Interest (APR): ${rate}%</p>
      <p>Monthly Payment: ‚Ç±${monthly}</p>
      <p>Confirm submission to proceed.</p>
      <button id="acceptLoanBtn" class="button">Accept & Submit</button>
      <button id="cancelLoanBtn" class="button">Cancel</button>
    `;

    modal.classList.add('active');

    document.getElementById('cancelLoanBtn').onclick =
      () => modal.classList.remove('active');

    document.getElementById('acceptLoanBtn').onclick = submitLoan;
  });

  async function submitLoan() {
    const payload = {
      user_id: Number(userId),
      amount: Number(document.getElementById('amount').value),
      term_months: Number(document.getElementById('term').value),
      income: Number(document.getElementById('income').value),
      employment_status: document.getElementById('employment').value,
      job_title: document.getElementById('jobTitle').value,
      purpose: document.getElementById('purpose').value
    };

    const resp = await fetch(`${apiBase}/apply`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    const body = await resp.json();
    if (!resp.ok) return alert("Error: " + body.error);

    modalBody.innerHTML = `
      <p>Application submitted (ID: ${body.applicationId}).</p>
      <button id="closeOk" class="button">OK</button>
    `;

    document.getElementById('closeOk').onclick =
      () => { modal.classList.remove('active'); loadLoanData(); };
  }
</script>

</body>
</html>
