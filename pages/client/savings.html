<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Savings Account</title>
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="header">
      <h2>BankSys</h2>
      <i class="hamburger" id="hamburger">&#9776;</i>
    </div>
    <ul>
      <li id="home"><i>üè†</i> <span>Dashboard</span></li>
      <li id="historyNav"><i>üìú</i> <span>Transaction History</span></li>
      <li id="profile"><i>‚öôÔ∏è</i> <span>Profile Settings</span></li>
      <li id="notifications"><i>üîî</i> <span>Notifications</span></li>
      <li id="logout"><i>üö™</i> <span>Logout</span></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <h1>Savings Account</h1>

    <!-- Balance -->
    <div class="balance-container">
      <p>Balance: ‚Ç±<span id="savingsBalance">0.00</span></p>
      <p id="savingsAccountId" class="subtext" style="font-weight: lighter; color: dimgray; font-size: 15px;"></p>
    </div>

    <!-- Go Back Button -->
    <div style="display:flex; justify-content:right;">
      <button class="button" id="goBackBtn" style="display:none;">Go Back</button>
    </div>

    <!-- Tiles Section (KEEP LAYOUT THE SAME) -->
    <div class="dashboard subtype-dashboard" id="subtypeTiles">
      <div class="card account-card account-open" id="depositTile">
        <h3>Deposit</h3>
        <p>Place funds into your account for safe keeping and future use.</p>
      </div>
      <div class="card account-card account-open" id="withdrawTile">
        <h3>Withdraw</h3>
        <p>Take funds out of your account for personal or business use.</p>
      </div>
      <div class="card account-card account-open" id="transferTile">
        <h3>Transfer</h3>
        <p>Move funds securely between your accounts or to another user.</p>
      </div>
      <div class="card account-card account-open" id="summaryTile">
        <h3>Savings Summary</h3>
        <p>View total saved and interest earned.</p>
      </div>
      <div class="card account-card account-open" id="historyTile">
        <h3>Transaction History</h3>
        <p>View all your savings transactions.</p>
      </div>
    </div>

    <!-- Freeze Button -->
    <div style="display:flex; justify-content:right; margin-top:12px;">
      <button class="button" id="freezeBtn" style="background-color: dodgerblue;">Freeze Account</button>
    </div>

    <!-- Form Container -->
    <div style="display:flex; justify-content:center; margin-top:18px;">
      <div class="form" id="formContainer" style="display:none"></div>
    </div>

    <!-- Transaction Table -->
    <div id="transactionContainer" style="margin-top:20px; display:none;">
      <div id="savingsMessage" class="message"></div>
      <table id="savingsTransactionTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Recipient / Description</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal -->
    <div class="modal" id="accountModal">
      <div class="modal-content">
        <span class="modal-close" id="modalClose">&times;</span>
        <p id="accountMessage"></p>
        <div id="modalActions" style="margin-top:20px; text-align:center;"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Utilities: normalize client
    // ---------------------------
    function normalizeClientObject(raw) {
      if (!raw || typeof raw !== 'object') return {};
      return {
        user_id: raw.user_id || raw.id || null,
        full_name: raw.full_name || raw.fullName || raw.name || null,
        email: raw.email || raw.emailAddress || null,

        savings_type_id: raw.savings_type_id || raw.savingsTypeId || null,
        savings_balance: raw.savings_balance !== undefined
          ? raw.savings_balance
          : (raw.savingsBalance !== undefined ? raw.savingsBalance : 0),

        deposit_type_id: raw.deposit_type_id || raw.depositTypeId || null,
        deposit_balance: raw.deposit_balance !== undefined
          ? raw.deposit_balance
          : (raw.depositBalance !== undefined ? raw.depositBalance : 0),

        loan_type_id: raw.loan_type_id || raw.loanTypeId || null,
        loan_balance: raw.loan_balance !== undefined
          ? raw.loan_balance
          : (raw.loanBalance !== undefined ? raw.loanBalance : 0),

        ...raw
      };
    }

    // ---------------------------
    // State & DOM
    // ---------------------------
    const token = localStorage.getItem('clientToken');
    if (!token) location.href = '../index.html';

    let _rawClient = JSON.parse(localStorage.getItem('clientData')) || {};
    let clientData = normalizeClientObject(_rawClient);
    const clientId = clientData?.user_id || null;

    function saveClientData(updated) {
      const normalized = normalizeClientObject(updated);
      localStorage.setItem('clientData', JSON.stringify(normalized));
      clientData = normalized;
    }

    const savingsBalance = document.getElementById('savingsBalance');
    const formContainer = document.getElementById('formContainer');
    const subtypeTiles = document.getElementById('subtypeTiles');
    const goBackBtn = document.getElementById('goBackBtn');
    const freezeBtn = document.getElementById('freezeBtn');
    const transactionContainer = document.getElementById('transactionContainer');
    const savingsMessage = document.getElementById('savingsMessage');

    const sidebar = document.getElementById('sidebar');
    const hamburger = document.getElementById('hamburger');
    const modal = document.getElementById('accountModal');
    const modalClose = document.getElementById('modalClose');
    const accountMessage = document.getElementById('accountMessage');
    const modalActions = document.getElementById('modalActions');

    modalClose.addEventListener('click', () => modal.classList.remove('active'));
    function showModal(message, actionsHTML = '') {
      accountMessage.innerHTML = message;
      modalActions.innerHTML = actionsHTML;
      modal.classList.add('active');
    }

    // ---------------------------
    // Fetch accounts
    // ---------------------------
    let savingsTypeId = clientData.savings_type_id || null;

    async function fetchClientAccounts() {
      try {
        const res = await fetch('/api/client/accounts', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to fetch accounts');
        const accounts = await res.json();

        accounts.forEach(acc => {
          if (acc.type_name === 'Savings') {
            clientData.savings_type_id = acc.type_id;
            clientData.savings_balance = acc.balance;
            savingsTypeId = acc.type_id;
          } else if (acc.type_name === 'Deposit') {
            clientData.deposit_type_id = acc.type_id;
            clientData.deposit_balance = acc.balance;
          } else if (acc.type_name === 'Loan') {
            clientData.loan_type_id = acc.type_id;
            clientData.loan_balance = acc.balance;
          }
        });

        saveClientData(clientData);
        savingsBalance.textContent = parseFloat(clientData.savings_balance || 0).toFixed(2);

        const savingsAccountId = document.getElementById("savingsAccountId");
        if (savingsAccountId) savingsAccountId.textContent = `Account ID: ${clientData.savings_type_id}`;

      } catch (err) {
        console.error('Fetch accounts error:', err);
        showModal('Could not fetch account info. Please log in again.');
      }
    }
    fetchClientAccounts();

    // ---------------------------
    // Sidebar navigation
    // ---------------------------
    hamburger.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
    document.getElementById('home').onclick = () => location.href = 'home.html';
    document.getElementById('historyNav').onclick = () => location.href = 'history.html';
    document.getElementById('profile').onclick = () => location.href = 'profile.html';
    document.getElementById('notifications').onclick = () => location.href = 'notifications.html';
    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('clientToken');
      localStorage.removeItem('clientData');
      location.href = '../index.html';
    };
    document.getElementById('home').style.backgroundColor = 'var(--accent-color)';
    document.getElementById('home').style.color = '#000';

    // ---------------------------
    // POST helper
    // ---------------------------
    async function postTransaction(url, data) {
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.message || 'Error');
        return json;
      } catch (err) {
        showModal(`Transaction failed: ${err.message}`);
        throw err;
      }
    }

    // ---------------------------
    // Freeze status (savings-specific)
    // ---------------------------
    const statusKey = `savings_status_${clientId}`;
    let status = localStorage.getItem(statusKey) || 'active';

    function applyStatusUI() {
      document.querySelectorAll('.account-card').forEach(tile => {
        if (status !== 'active') {
          if (tile.id !== 'historyTile') tile.classList.add('account-closed');
        } else tile.classList.remove('account-closed');
      });
      if (status === 'active') freezeBtn.textContent = 'Freeze Account';
      if (status === 'pending_freeze') freezeBtn.textContent = 'Freeze Pending...';
      if (status === 'frozen') freezeBtn.textContent = 'Unfreeze Account';
      if (status === 'pending_unfreeze') freezeBtn.textContent = 'Unfreeze Pending...';
    }
    applyStatusUI();

    function saveStatus(newStatus) {
      status = newStatus;
      localStorage.setItem(statusKey, newStatus);
      applyStatusUI();
    }

    freezeBtn.addEventListener('click', () => {
      if (status === 'active') {
        showModal("Are you sure you want to freeze this account?",
          `<div style="display:flex; gap:10px; justify-content:center;">
            <button id='confirmFreeze'>Proceed</button>
            <button id='cancelFreeze'>Cancel</button>
          </div>`);
        document.getElementById('confirmFreeze').onclick = () => {
          saveStatus('pending_freeze');
          showModal("Freeze request sent. Awaiting admin approval.");
        };
        document.getElementById('cancelFreeze').onclick = () => modal.classList.remove('active');
      } else if (status === 'frozen') {
        showModal("Request to unfreeze this account?",
          `<div style="display:flex; gap:10px; justify-content:center;">
            <button id='confirmUnfreeze'>Proceed</button>
            <button id='cancelUnfreeze'>Cancel</button>
          </div>`);
        document.getElementById('confirmUnfreeze').onclick = () => {
          saveStatus('pending_unfreeze');
          showModal("Unfreeze request sent. Waiting for admin approval.");
        };
        document.getElementById('cancelUnfreeze').onclick = () => modal.classList.remove('active');
      } else {
        showModal("A request is already being processed.");
      }
    });

    function tileBlocked(){ return status !== 'active'; }
    function blockedClick(){ showModal("This account is currently on hold due to a freeze/unfreeze request."); }

    // ---------------------------
    // Subtype actions (deposit / withdraw / transfer / summary / history)
    // ---------------------------
    const subtypes = [
      { id: 'depositTile', type: 'deposit', route: '/api/transactions/deposit' },
      { id: 'withdrawTile', type: 'withdraw', route: '/api/transactions/withdraw' },
      { id: 'transferTile', type: 'transfer', route: '/api/transactions/transfer' },
      { id: 'summaryTile', type: 'summary' },
      { id: 'historyTile', type: 'history' }
    ];

    subtypes.forEach(sub => {
      const el = document.getElementById(sub.id);
      if (!el) return;

      el.onclick = async () => {
        if (tileBlocked()) { blockedClick(); return; }

        // ensure latest type id/balance
        if (!clientData.savings_type_id) await fetchClientAccounts();
        const typeId = clientData.savings_type_id;

        if (sub.type === 'history') {
          // Transaction history
          subtypeTiles.style.display = 'none';
          formContainer.style.display = 'none';
          transactionContainer.style.display = 'block';
          goBackBtn.style.display = 'inline-block';
          freezeBtn.style.display = 'none';
          savingsMessage.textContent = 'Fetching transactions...';

          try {
            const res = await fetch(`/api/transactions/history/account/Savings`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            savingsMessage.textContent = `Fetched ${data.length} transactions.`;

            const tbody = document.querySelector('#savingsTransactionTable tbody');
            tbody.innerHTML = '';
            data.forEach(tx => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${new Date(tx.transaction_date).toLocaleString()}</td>
                <td>${tx.transaction_type}</td>
                <td>‚Ç±${parseFloat(tx.amount).toFixed(2)}</td>
                <td>${tx.description || '-'}</td>
              `;
              tbody.appendChild(tr);
            });
          } catch (err) {
            savingsMessage.textContent = 'Failed to fetch transactions';
            savingsMessage.classList.add('error');
            console.error(err);
          }

        } else if (sub.type === 'summary') {
          // Savings summary
          subtypeTiles.style.display = 'none';
          transactionContainer.style.display = 'none';
          formContainer.innerHTML = '<p>Loading summary...</p>';
          formContainer.style.display = 'flex';
          freezeBtn.style.display = 'none';
          goBackBtn.style.display = 'inline-block';

          try {
            const res = await fetch(`/api/transactions/savings/summary`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const summary = await res.json();

            // Sync frontend with backend
            clientData.savings_balance = summary.currentSavings || 0;
            saveClientData(clientData);
            savingsBalance.textContent = parseFloat(clientData.savings_balance).toFixed(2);

            const totalDeposits = summary.totalDeposits || 0;
            const totalWithdrawals = summary.totalWithdrawals || 0;
            const totalInterest = summary.interestEarned || 0;
            const net = summary.currentSavings || 0;

            formContainer.innerHTML = `
              <div class="form" style="display:flex; justify-content:center;">
                <div class="card account-card summary-card" style="padding:20px; flex-direction:column; align-items:center; width:320px;">
                  <h2 style="margin-bottom:15px;">Savings Summary</h2>
                  <p>Total Deposits: ‚Ç±${totalDeposits.toFixed(2)}</p>
                  <p>Total Withdrawals: ‚Ç±${totalWithdrawals.toFixed(2)}</p>
                  <p>Interest Earned: ‚Ç±${totalInterest.toFixed(2)}</p>
                  <hr style="width:100%; margin:12px 0;">
                  <p><strong>Current Saved: ‚Ç±${net.toFixed(2)}</strong></p>
                </div>
              </div>
            `;
          } catch (err) {
            console.error('Summary load error', err);
            formContainer.innerHTML = '<p>Failed to load summary.</p>';
          }

        } else {
          // Deposit / Withdraw / Transfer
          let formHtml = `<form id="${sub.type}Form"><h2>${sub.type.charAt(0).toUpperCase() + sub.type.slice(1)} Money</h2>`;
          if (sub.type === 'transfer') {
            formHtml += `<input type="number" id="recipientId" placeholder="Recipient Account ID" required>`;
          }
          formHtml += `<input type="number" id="amountInput" placeholder="Amount" required>`;
          formHtml += `<button type="submit">${sub.type.charAt(0).toUpperCase() + sub.type.slice(1)}</button></form>`;

          subtypeTiles.style.display = 'none';
          transactionContainer.style.display = 'none';
          formContainer.innerHTML = formHtml;
          formContainer.style.display = 'flex';
          freezeBtn.style.display = 'none';
          goBackBtn.style.display = 'inline-block';

          const formEl = document.getElementById(`${sub.type}Form`);
          formEl.onsubmit = async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('amountInput').value);
            if (isNaN(amount) || amount <= 0) return showModal('Enter a valid amount.');

            let payload;
            let endpoint = sub.route;

            if (sub.type === 'transfer') {
              const toTypeId = parseInt(document.getElementById('recipientId').value);
              if (!toTypeId) return showModal('Enter recipient account id.');
              if (toTypeId === typeId) return showModal('Cannot transfer to the same account.');
              payload = { fromTypeId: typeId, toTypeId, amount };
            } else {
              payload = { typeId, amount };
            }

            try {
              const result = await postTransaction(endpoint, payload);

              // Sync frontend balance with backend if available
              if (result.newBalance !== undefined && result.newBalance !== null) {
                clientData.savings_balance = parseFloat(result.newBalance);
              } else {
                clientData.savings_balance = sub.type === 'deposit'
                  ? (parseFloat(clientData.savings_balance || 0) + amount)
                  : (parseFloat(clientData.savings_balance || 0) - amount);
              }

              saveClientData(clientData);
              savingsBalance.textContent = parseFloat(clientData.savings_balance).toFixed(2);
              await fetchClientAccounts();

              if (sub.type === 'transfer') {
                showModal(`Transfer of ‚Ç±${amount.toFixed(2)} successful.<br>Sent to Account ID: ${payload.toTypeId}.`);
              } else {
                showModal(`${sub.type.charAt(0).toUpperCase() + sub.type.slice(1)} of ‚Ç±${amount.toFixed(2)} successful.`);
              }

            } catch (err) {
              console.error('Transaction error', err);
            }
          };
        }
      };
    });

    // ---------------------------
    // Go back UI handler
    // ---------------------------
    goBackBtn.onclick = () => {
      formContainer.innerHTML = '';
      formContainer.style.display = 'none';
      transactionContainer.style.display = 'none';
      subtypeTiles.style.display = 'flex';
      goBackBtn.style.display = 'none';
      freezeBtn.style.display = 'inline-block';
    };
  </script>
</body>
</html>
