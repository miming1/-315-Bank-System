<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Savings Account</title>
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="header">
      <h2>BankSys</h2>
      <i class="hamburger" id="hamburger">&#9776;</i>
    </div>
    <ul>
      <li id="home"><i>üè†</i> <span>Dashboard</span></li>
      <li id="historyNav"><i>üìú</i> <span>Transaction History</span></li>
      <li id="profile"><i>‚öôÔ∏è</i> <span>Profile Settings</span></li>
      <li id="notifications"><i>üîî</i> <span>Notifications</span></li>
      <li id="logout"><i>üö™</i> <span>Logout</span></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <h1>Savings Account</h1>

    <!-- Balance -->
    <div class="balance-container">
      <p>Balance: ‚Ç±<span id="savingsBalance">0.00</span></p>
      <p id="savingsAccountId" class="subtext" style="font-weight: lighter; color: dimgray; font-size: 15px;"></p>
      <p id="savingsAccountStatus" class="subtext" style="font-weight: lighter; color: dimgray; font-size: 15px;"></p>
    </div>

    <!-- Go Back Button -->
    <div style="display:flex; justify-content:right;">
      <button class="button" id="goBackBtn" style="display:none;">Go Back</button>
    </div>

    <!-- Tiles Section (KEEP LAYOUT THE SAME) -->
    <div class="dashboard subtype-dashboard" id="subtypeTiles">
      <div class="card account-card account-open" id="depositTile">
        <h3>Deposit</h3>
        <p>Place funds into your account for safe keeping and future use.</p>
      </div>
      <div class="card account-card account-open" id="withdrawTile">
        <h3>Withdraw</h3>
        <p>Take funds out of your account for personal or business use.</p>
      </div>
      <div class="card account-card account-open" id="transferTile">
        <h3>Transfer</h3>
        <p>Move funds securely between your accounts or to another user.</p>
      </div>
      <div class="card account-card account-open" id="summaryTile">
        <h3>Savings Summary</h3>
        <p>View total saved and interest earned.</p>
      </div>
      <div class="card account-card account-open" id="historyTile">
        <h3>Transaction History</h3>
        <p>View all your savings transactions.</p>
      </div>
    </div>

    <!-- Freeze Button -->
    <div style="display:flex; justify-content:right; margin-top:12px;">
      <button class="button" id="freezeBtn" style="background-color: dodgerblue;">Freeze Account</button>
    </div>

    <!-- Form Container -->
    <div style="display:flex; justify-content:center; margin-top:18px;">
      <div class="form" id="formContainer" style="display:none"></div>
    </div>

    <!-- Transaction Table -->
    <div id="transactionContainer" style="margin-top:20px; display:none;">
      <div id="savingsMessage" class="message"></div>
      <table id="savingsTransactionTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Recipient / Description</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modals (base + freeze / pending) -->
    <div class="modal" id="accountModal" style="display:none;">
      <div class="modal-content">
        <span class="modal-close" id="modalClose">&times;</span>
        <p id="accountMessage"></p>
        <div id="modalActions" style="margin-top:20px; text-align:center;"></div>
      </div>
    </div>

    <!-- Freeze Warning Modal (kept for compatibility) -->
    <div class="modal" id="freezeWarningModal" style="display:none;">
      <div class="modal-content">
        <span class="modal-close" id="freezeWarningClose">&times;</span>
        <p>Your account is currently frozen or freeze/unfreeze request is pending. Action not permitted.</p>
      </div>
    </div>

    <!-- Pending Action Modal -->
    <div class="modal" id="pendingModal" style="display:none;">
      <div class="modal-content">
        <span class="modal-close" id="pendingModalClose">&times;</span>
        <p id="pendingModalText"></p>
        <div style="text-align:center; margin-top:20px;">
          <button class="button" id="cancelRequestBtn">Cancel Request</button>
          <button class="button" id="pendingCloseBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- Overlay + feature-unavailable modal (ADDED to show when tile locked) -->
    <div id="modalOverlay" class="modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:999;"></div>

    <div class="modal" id="featureUnavailableModal" style="display:none; z-index:1000;">
      <div class="modal-content">
        <span class="modal-close" id="featureUnavailableClose">&times;</span>
        <p>This feature is unavailable while the account is frozen or a freeze/unfreeze request is pending.</p>
      </div>
    </div>

  </div>

  <script>
    /* ====== Utilities & Normalization ====== */
    function normalizeClientObject(raw = {}) {
      if (!raw || typeof raw !== 'object') return {};
      return {
        user_id: raw.user_id || raw.id || null,
        full_name: raw.full_name || raw.fullName || raw.name || null,
        email: raw.email || raw.emailAddress || null,

        savings_type_id: raw.savings_type_id || raw.savingsTypeId || null,
        savings_balance: raw.savings_balance !== undefined
          ? raw.savings_balance
          : (raw.savingsBalance !== undefined ? raw.savingsBalance : 0),

        deposit_type_id: raw.deposit_type_id || raw.depositTypeId || null,
        deposit_balance: raw.deposit_balance !== undefined
          ? raw.deposit_balance
          : (raw.depositBalance !== undefined ? raw.depositBalance : 0),

        loan_type_id: raw.loan_type_id || raw.loanTypeId || null,
        loan_balance: raw.loan_balance !== undefined
          ? raw.loan_balance
          : (raw.loanBalance !== undefined ? raw.loanBalance : 0),

        savings_status: raw.savings_status || raw.savingsStatus || null,

        ...raw
      };
    }

    function normalizeStatus(status) {
      if (status === null || status === undefined) return null;
      const s = String(status).trim().toLowerCase();
      if (s === 'open' || s === 'active') return 'Open';
      if (s === 'frozen') return 'Frozen';
      if (s === 'pending freeze' || s === 'pending_freeze' || s === 'pendingfreeze') return 'Pending Freeze';
      if (s === 'pending unfreeze' || s === 'pending_unfreeze' || s === 'pendingunfreeze') return 'Pending Unfreeze';
      return status;
    }

    /* ====== Local state ====== */
    let _rawClient = JSON.parse(localStorage.getItem('clientData')) || {};
    let clientData = normalizeClientObject(_rawClient);
    const clientToken = localStorage.getItem('clientToken') || '';
    // initial normalize
    clientData.savings_status = normalizeStatus(clientData.savings_status);

    function saveClientData(updated) {
      const normalized = normalizeClientObject(updated);
      localStorage.setItem('clientData', JSON.stringify(normalized));
      clientData = normalized;
    }

    /* ====== Elements ====== */
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.getElementById('hamburger');

    const modal = document.getElementById('accountModal');
    const modalClose = document.getElementById('modalClose');
    const accountMessage = document.getElementById('accountMessage');
    const modalActions = document.getElementById('modalActions');

    const pendingModal = document.getElementById('pendingModal');
    const pendingModalClose = document.getElementById('pendingModalClose');
    const pendingCloseBtn = document.getElementById('pendingCloseBtn');
    const cancelRequestBtn = document.getElementById('cancelRequestBtn');
    const pendingModalText = document.getElementById('pendingModalText');

    const freezeWarningModal = document.getElementById('freezeWarningModal');
    const freezeWarningClose = document.getElementById('freezeWarningClose');

    // feature-unavailable modal + overlay
    const modalOverlay = document.getElementById('modalOverlay');
    const featureUnavailableModal = document.getElementById('featureUnavailableModal');
    const featureUnavailableClose = document.getElementById('featureUnavailableClose');

    const formContainer = document.getElementById('formContainer');
    const subtypeTiles = document.getElementById('subtypeTiles');
    const savingsBalance = document.getElementById('savingsBalance');
    const savingsAccountId = document.getElementById('savingsAccountId');
    const savingsAccountStatus = document.getElementById('savingsAccountStatus');
    const goBackBtn = document.getElementById('goBackBtn');
    const freezeBtn = document.getElementById('freezeBtn');
    const transactionContainer = document.getElementById('transactionContainer');
    const savingsMessage = document.getElementById('savingsMessage');

    /* ====== Modal helpers ====== */
    function openModal(el) { if (!el) return; el.style.display = 'flex'; }
    function closeModal(el) { if (!el) return; el.style.display = 'none'; }

    function showModal(message, actionsHTML = '') {
      if (!modal) { alert(message); return; }
      accountMessage.innerHTML = message;
      modalActions.innerHTML = actionsHTML;
      openModal(modal);
    }

    modalClose?.addEventListener('click', () => closeModal(modal));
    pendingModalClose?.addEventListener('click', () => closeModal(pendingModal));
    pendingCloseBtn?.addEventListener('click', () => closeModal(pendingModal));
    freezeWarningClose?.addEventListener('click', () => closeModal(freezeWarningModal));

    // feature-unavailable handlers
    featureUnavailableClose?.addEventListener('click', () => {
      if (modalOverlay) modalOverlay.style.display = 'none';
      if (featureUnavailableModal) featureUnavailableModal.style.display = 'none';
    });

    function showFeatureBlockedModal() {
      if (modalOverlay) modalOverlay.style.display = 'block';
      if (featureUnavailableModal) featureUnavailableModal.style.display = 'flex';
    }

    /* ====== Fetch / Update ====== */
    async function fetchClientAccounts() {
      try {
        const res = await fetch('/api/client/accounts', {
          headers: { 'Authorization': `Bearer ${clientToken}` }
        });
        if (!res.ok) throw new Error('Failed to fetch accounts');
        const accounts = await res.json();

        const savingsAcc = Array.isArray(accounts) ? accounts.find(acc => acc.type_name === 'Savings') : null;
        if (savingsAcc) {
          clientData.savings_type_id = savingsAcc.type_id;
          clientData.savings_balance = savingsAcc.balance;
          clientData.savings_status = normalizeStatus(savingsAcc.account_status || savingsAcc.status || savingsAcc.statusText);
        } else {
          clientData.savings_type_id = null;
          clientData.savings_balance = 0;
          clientData.savings_status = null;
        }

        saveClientData(clientData);

        savingsBalance.textContent = parseFloat(clientData.savings_balance || 0).toFixed(2);
        savingsAccountId.textContent = `Account ID: ${clientData.savings_type_id || '-'}`;
        savingsAccountStatus.textContent = `Status: ${clientData.savings_status || 'Unknown'}`;

        updateFreezeButton();
        updateSubtypeTileLock();
      } catch (err) {
        console.error('Fetch accounts error:', err);
        showModal('Could not fetch account info. Please log in again.');
      }
    }

    /* ====== Freeze button logic ====== */
    function updateFreezeButton() {
      const status = clientData.savings_status;

      switch (status) {
        case 'Open':
          freezeBtn.textContent = 'Freeze Account';
          freezeBtn.disabled = false;
          break;
        case 'Frozen':
          freezeBtn.textContent = 'Unfreeze Account';
          freezeBtn.disabled = false;
          break;
        case 'Pending Freeze':
          freezeBtn.textContent = 'Freeze Pending...';
          freezeBtn.disabled = false;
          break;
        case 'Pending Unfreeze':
          freezeBtn.textContent = 'Unfreeze Pending...';
          freezeBtn.disabled = false;
          break;
        default:
          freezeBtn.textContent = 'Freeze Account';
          freezeBtn.disabled = false;
      }
    }

    function openPendingModal() {
      const s = clientData.savings_status;
      const msg = (s === 'Pending Freeze')
        ? 'Your freeze request is currently pending admin review. You can cancel the request if you want to stop it.'
        : (s === 'Pending Unfreeze')
        ? 'Your unfreeze request is currently pending admin review. You can cancel the request if you want to stop it.'
        : 'Your request is being reviewed.';
      if (pendingModalText) pendingModalText.textContent = msg;
      openModal(pendingModal);
    }

    async function performClientFreezeAction(action) {
      const typeId = clientData.savings_type_id;
      if (!typeId) return showModal('Account type not found.');

      try {
        const res = await fetch(`/api/client/account/${typeId}/${action}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${clientToken}` }
        });
        let data;
        try { data = await res.json(); } catch (e) { data = {}; }
        if (!res.ok) {
          return showModal(data.message || 'Unable to update status.');
        }

        // re-fetch authoritative state
        await fetchClientAccounts();
        showModal(data.message || 'Request submitted.');
      } catch (err) {
        console.error(err);
        showModal('Failed to submit request.');
      }
    }

    /* Freeze button click handler */
    freezeBtn?.addEventListener('click', () => {
      const status = clientData.savings_status;
      if (status === 'Pending Freeze' || status === 'Pending Unfreeze') {
        openPendingModal();
        return;
      }

      const action = (status === 'Frozen') ? 'unfreeze' : 'freeze';
      const message = (action === 'freeze')
        ? 'Are you sure you want to request a freeze on this account? Transactions will be paused while admin reviews this request.'
        : 'Are you sure you want to request an unfreeze of this account?';

      showModal(message,
        `<div style="display:flex; gap:10px; justify-content:center;">
           <button id='confirmProceed'>Proceed</button>
           <button id='cancelProceed'>Cancel</button>
         </div>`);

      document.getElementById('cancelProceed').onclick = () => closeModal(modal);
      document.getElementById('confirmProceed').onclick = async () => {
        closeModal(modal);
        await performClientFreezeAction(action);
      };
    });

    /* Cancel pending request */
    cancelRequestBtn?.addEventListener('click', async () => {
      if (!confirm('Cancel the pending request? This will revert to the previous account state.')) return;
      const typeId = clientData.savings_type_id;
      if (!typeId) return showModal('Account type not found.');

      try {
        const res = await fetch(`/api/client/account/${typeId}/cancel`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${clientToken}` }
        });
        let data;
        try { data = await res.json(); } catch (_) { data = {}; }
        if (!res.ok) return showModal(data.message || 'Failed to cancel request.');

        await fetchClientAccounts();
        showModal(data.message || 'Request canceled.');
        closeModal(pendingModal);
      } catch (err) {
        console.error(err);
        showModal('Failed to cancel request.');
      }
    });

    /* ====== Tile locking & click handling ====== */
    function updateSubtypeTileLock() {
      const status = clientData.savings_status;
      const locked = (status === 'Frozen' || status === 'Pending Freeze' || status === 'Pending Unfreeze');

      // select all account tiles
      const tiles = document.querySelectorAll('.card.account-card');
      tiles.forEach(tile => {
        const id = tile.id;
        if (id === 'historyTile') {
          tile.classList.remove('disabled');
          tile.style.opacity = '1';
          tile.dataset.locked = 'false';
          return;
        }
        if (locked) {
          tile.classList.add('disabled');
          tile.style.opacity = '0.5';
          tile.dataset.locked = 'true';
        } else {
          tile.classList.remove('disabled');
          tile.style.opacity = '1';
          tile.dataset.locked = 'false';
        }
      });
    }

    function setupSubtypeTileHandlers() {
      const mapping = {
        depositTile: { type: 'deposit', route: '/api/transactions/deposit' },
        withdrawTile: { type: 'withdraw', route: '/api/transactions/withdraw' },
        transferTile: { type: 'transfer', route: '/api/transactions/transfer' },
        historyTile: { type: 'history' },
        summaryTile: { type: 'summary' }
      };

      Object.keys(mapping).forEach(tileId => {
        const element = document.getElementById(tileId);
        if (!element) return;

        element.addEventListener('click', async (e) => {
          // If locked, show the feature-unavailable modal
          if (element.dataset.locked === 'true') {
            showFeatureBlockedModal();
            return;
          }

          const sub = mapping[tileId];

          // HISTORY
          if (sub.type === 'history') {
            subtypeTiles.style.display = 'none';
            formContainer.style.display = 'none';
            transactionContainer.style.display = 'block';
            goBackBtn.style.display = 'inline-block';
            freezeBtn.style.display = 'none';
            savingsMessage.textContent = 'Fetching transactions...';

            try {
              const res = await fetch(`/api/transactions/history/account/Savings`, {
                headers: { 'Authorization': `Bearer ${clientToken}` }
              });
              const data = await res.json();
              savingsMessage.textContent = `Fetched ${data.length} transactions.`;

              const tbody = document.querySelector('#savingsTransactionTable tbody');
              tbody.innerHTML = "";
              data.forEach(tx => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td>${new Date(tx.transaction_date).toLocaleString()}</td>
                  <td>${tx.transaction_type}</td>
                  <td>‚Ç±${parseFloat(tx.amount).toFixed(2)}</td>
                  <td>${tx.description || '-'}</td>
                `;
                tbody.appendChild(tr);
              });
            } catch (err) {
              savingsMessage.textContent = 'Failed to fetch transactions';
              savingsMessage.classList.add('error');
              console.error(err);
            }
            return;
          }

          // SUMMARY
          if (sub.type === 'summary') {
            subtypeTiles.style.display = 'none';
            transactionContainer.style.display = 'none';
            formContainer.innerHTML = '<p>Loading summary...</p>';
            formContainer.style.display = 'flex';
            freezeBtn.style.display = 'none';
            goBackBtn.style.display = 'inline-block';

            try {
              const res = await fetch(`/api/transactions/savings/summary`, {
                headers: { 'Authorization': `Bearer ${clientToken}` }
              });
              const summary = await res.json();

              clientData.savings_balance = summary.currentSavings || 0;
              saveClientData(clientData);
              savingsBalance.textContent = parseFloat(clientData.savings_balance).toFixed(2);

              const totalDeposits = summary.totalDeposits || 0;
              const totalWithdrawals = summary.totalWithdrawals || 0;
              const totalInterest = summary.interestEarned || 0;
              const net = summary.currentSavings || 0;

              formContainer.innerHTML = `
                <div class="form" style="display:flex; justify-content:center;">
                  <div class="card account-card summary-card" style="padding:20px; flex-direction:column; align-items:center; width:320px;">
                    <h2 style="margin-bottom:15px;">Savings Summary</h2>
                    <p>Total Deposits: ‚Ç±${totalDeposits.toFixed(2)}</p>
                    <p>Total Withdrawals: ‚Ç±${totalWithdrawals.toFixed(2)}</p>
                    <p>Interest Earned: ‚Ç±${totalInterest.toFixed(2)}</p>
                    <hr style="width:100%; margin:12px 0;">
                    <p><strong>Current Saved: ‚Ç±${net.toFixed(2)}</strong></p>
                  </div>
                </div>
              `;
            } catch (err) {
              console.error('Summary load error', err);
              formContainer.innerHTML = '<p>Failed to load summary.</p>';
            }
            return;
          }

          // DEPOSIT / WITHDRAW / TRANSFER
          let formHtml = `<form id="${sub.type}Form"><h2>${sub.type.charAt(0).toUpperCase() + sub.type.slice(1)} Money</h2>`;
          if (sub.type === 'transfer') {
            formHtml += `<input type="number" placeholder="Recipient Account ID" required>`;
          }
          formHtml += `<input type="number" placeholder="Amount" required>`;
          formHtml += `<button type="submit">${sub.type.charAt(0).toUpperCase() + sub.type.slice(1)}</button></form>`;

          formContainer.innerHTML = formHtml;
          formContainer.style.display = 'block';
          subtypeTiles.style.display = 'none';
          transactionContainer.style.display = 'none';
          freezeBtn.style.display = 'none';
          goBackBtn.style.display = 'inline-block';

          const formEl = document.getElementById(`${sub.type}Form`);
          formEl.onsubmit = async e => {
            e.preventDefault();
            const typeId = clientData.savings_type_id;
            let amount, toTypeId;
            if (sub.type === 'transfer') {
              toTypeId = parseInt(e.target[0].value);
              amount = parseFloat(e.target[1].value);
            } else {
              amount = parseFloat(e.target[0].value);
            }
            if (isNaN(amount) || amount <= 0) return showModal('Enter a valid amount.');

            const payload = sub.type === 'transfer' ? { fromTypeId: typeId, toTypeId, amount } : { typeId, amount };

            try {
              const result = await postTransaction(sub.route, payload);
              if (result.newBalance !== undefined && result.newBalance !== null) {
                clientData.savings_balance = parseFloat(result.newBalance);
              } else {
                clientData.savings_balance = sub.type === 'deposit'
                  ? (parseFloat(clientData.savings_balance || 0) + amount)
                  : (parseFloat(clientData.savings_balance || 0) - amount);
              }
              saveClientData(clientData);
              savingsBalance.textContent = parseFloat(clientData.savings_balance).toFixed(2);
              await fetchClientAccounts();

              if (sub.type === 'transfer') {
                showModal(`Transfer of ‚Ç±${amount.toFixed(2)} successful.<br>Sent to Account ID: ${payload.toTypeId}.`);
              } else {
                showModal(`${sub.type.charAt(0).toUpperCase() + sub.type.slice(1)} of ‚Ç±${amount.toFixed(2)} successful.`);
              }
            } catch (err) {
              console.error(err);
              showModal('Transaction failed.');
            }
          };
        });
      });
    }

    /* ====== Transaction helper ====== */
    async function postTransaction(url, data) {
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${clientToken}`
          },
          body: JSON.stringify(data)
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.message || 'Error');
        return json;
      } catch (err) {
        showModal(`Transaction failed: ${err.message}`);
        throw err;
      }
    }

    /* ====== Go Back button functionality ====== */
    goBackBtn?.addEventListener('click', () => {
      // hide any opened form or transaction view and restore tiles + freeze button
      formContainer.innerHTML = '';
      formContainer.style.display = 'none';
      transactionContainer.style.display = 'none';
      subtypeTiles.style.display = 'flex';
      freezeBtn.style.display = 'inline-block';
      goBackBtn.style.display = 'none';
    });

    /* ====== Navigation / Sidebar highlight ====== */
    document.getElementById('home')?.addEventListener('click', () => location.href = 'home.html');
    document.getElementById('historyNav')?.addEventListener('click', () => location.href = 'history.html');
    document.getElementById('profile')?.addEventListener('click', () => location.href = 'profile.html');
    document.getElementById('notifications')?.addEventListener('click', () => location.href = 'notifications.html');
    document.getElementById('logout')?.addEventListener('click', () => {
      localStorage.removeItem('clientToken');
      localStorage.removeItem('clientData');
      location.href = '../index.html';
    });

    function highlightCurrentPage() {
      const path = window.location.pathname;
      const file = path.split('/').pop();
      if (file === 'savings.html') {
        document.getElementById('home').style.backgroundColor = 'var(--accent-color)';
        document.getElementById('home').style.color = '#000';
      }
    }
    highlightCurrentPage();

    /* ====== Init ====== */
    setupSubtypeTileHandlers();
    fetchClientAccounts();

  </script>
</body>
</html>
