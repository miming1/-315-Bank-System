<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Settings</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="header">
      <h2>BankSys</h2>
      <i class="hamburger" id="hamburger">&#9776;</i>
    </div>
    <ul>
      <li id="dashboard"><i>ğŸ </i> <span>Dashboard</span></li>
      <li id="history"><i>ğŸ“œ</i> <span>Transaction History</span></li>
      <li id="profile"><i>âš™ï¸</i> <span>Profile Settings</span></li>
      <li id="notifications">
        <i>ğŸ””</i>
        <span style="display:flex; align-items:center; gap:8px;">
          Notifications
          <span id="notifDot" style="
            width:10px; height:10px; background:red; border-radius:50%; display:none;">
          </span>
        </span>
      </li>
      <li id="logout"><i>ğŸšª</i> <span>Logout</span></li>
    </ul>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <button class="back-btn" id="goBack">â† Back to Home</button>

    <div class="profile-card">
      <h2>Profile Settings</h2>

      <div class="profile-field">
        <label>Name:</label>
        <span id="viewName">Loading...</span>
        <input type="text" id="editName" style="display:none;">
      </div>

      <div class="profile-field">
        <label>Username:</label>
        <span id="viewEmail">Loading...</span>
        <input type="text" id="editEmail" style="display:none;">
      </div>

      <div class="profile-field">
        <label>Password:</label>
        <span id="viewPassword">********</span>
        <input type="password" id="editPassword" placeholder="Enter new password" style="display:none;">
      </div>

      <div style="display:flex; gap:10px; margin-top:15px;">
        <button id="editBtn">Edit Profile</button>
        <button id="deleteBtn" class="delete-button" style="background-color: darkred;">Delete Account</button>
      </div>

      <p id="deleteStatusLabel" style="margin-top:10px; font-size:0.9rem; color:var(--error-color);"></p>
      <div class="message" id="message"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="accountModal">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">&times;</span>
      <p id="accountMessage"></p>
      <div id="modalActions"></div>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById('sidebar');
    const sidebarItems = document.querySelectorAll('.sidebar ul li');
    sidebarItems.forEach(item => {
      const page = item.id + '.html';
      if (window.location.pathname.endsWith(page)) {
        item.style.backgroundColor = 'var(--accent-color)';
        item.style.color = '#000';
      }
    });

    const hamburger = document.getElementById('hamburger');
    hamburger.addEventListener('click', () => sidebar.classList.toggle('collapsed'));

    const clientToken = localStorage.getItem('clientToken');
    const messageDiv = document.getElementById('message');

    const viewName = document.getElementById('viewName');
    const viewEmail = document.getElementById('viewEmail');
    const viewPassword = document.getElementById('viewPassword');
    const editName = document.getElementById('editName');
    const editEmail = document.getElementById('editEmail');
    const editPassword = document.getElementById('editPassword');
    const editBtn = document.getElementById('editBtn');
    const goBack = document.getElementById('goBack');
    const deleteBtn = document.getElementById('deleteBtn');
    const deleteStatusLabel = document.getElementById('deleteStatusLabel');

    // Sidebar navigation
    document.getElementById('dashboard').addEventListener('click', () => window.location.href = 'home.html');
    document.getElementById('history').addEventListener('click', () => window.location.href = 'history.html');
    document.getElementById('profile').addEventListener('click', () => window.location.href = 'profile.html');
    document.getElementById('notifications').addEventListener('click', () => window.location.href = 'notifications.html');
    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('clientToken');
      window.location.href = '../index.html';
    });

    goBack.addEventListener('click', () => window.location.href = 'home.html');

    let editMode = false;

    async function loadProfile() {
      if (!clientToken) return showError("No token found. Please login again.");

      try {
        const res = await fetch('/api/client/profile/me', {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${clientToken}` }
        });
        const data = await res.json();

        if (!res.ok) return showError(data.message || "Failed to load profile.");

        viewName.textContent = data.full_name;
        viewEmail.textContent = data.email;
        editName.value = data.full_name;
        editEmail.value = data.email;
      } catch (err) {
        console.error(err);
        showError("Server error while fetching profile.");
      }
    }

    function showError(msg) {
      messageDiv.textContent = msg;
      messageDiv.className = "message error";
    }

    loadProfile();

    // Edit / Save Profile
    editBtn.addEventListener('click', async () => {
      if (!editMode) {
        editMode = true;
        viewName.style.display = 'none';
        viewEmail.style.display = 'none';
        viewPassword.style.display = 'none';
        editName.style.display = 'block';
        editEmail.style.display = 'block';
        editPassword.style.display = 'block';
        editBtn.textContent = "Save Changes";
      } else {
        const payload = {
          fullName: editName.value.trim(),
          email: editEmail.value.trim()
        };
        if (editPassword.value.trim()) payload.password = editPassword.value.trim();

        try {
          const res = await fetch('/api/client/profile/me', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${clientToken}`
            },
            body: JSON.stringify(payload)
          });
          const data = await res.json();

          if (res.ok) {
            viewName.textContent = payload.fullName;
            viewEmail.textContent = payload.email;
            editPassword.value = '';
            const clientData = JSON.parse(localStorage.getItem('clientData')) || {};
            clientData.full_name = payload.fullName;
            clientData.email = payload.email;
            localStorage.setItem('clientData', JSON.stringify(clientData));

            editMode = false;
            viewName.style.display = 'inline';
            viewEmail.style.display = 'inline';
            viewPassword.style.display = 'inline';
            editName.style.display = 'none';
            editEmail.style.display = 'none';
            editPassword.style.display = 'none';
            editBtn.textContent = "Edit Profile";

            messageDiv.textContent = "Profile updated successfully!";
            messageDiv.className = "message success";
          } else {
            messageDiv.textContent = data.message || "Failed to update profile.";
            messageDiv.className = "message error";
          }
        } catch (err) {
          console.error(err);
          messageDiv.textContent = "Server error while updating profile.";
          messageDiv.className = "message error";
        }
      }
    });

    // DELETE ACCOUNT
    const modal = document.getElementById('accountModal');
    const modalClose = document.getElementById('modalClose');
    const accountMessage = document.getElementById('accountMessage');
    const modalActions = document.getElementById('modalActions');

    let deleteStatus = localStorage.getItem('delete_status') || 'none';
    updateDeleteLabel();

    function updateDeleteLabel() {
      if(deleteStatus === 'pending') deleteStatusLabel.textContent = "Deletion Request Pending Admin Approval";
      else if(deleteStatus === 'approved') deleteStatusLabel.textContent = "Account Approved for Deletion (Please Withdraw Balances)";
      else deleteStatusLabel.textContent = "";
    }

    modalClose.addEventListener('click', () => modal.classList.remove('active'));
    function showModal(message, actionsHTML=''){
      accountMessage.innerHTML = message;
      modalActions.innerHTML = actionsHTML;
      modal.classList.add('active');
    }

    function saveDeleteStatus(newStatus){
      deleteStatus = newStatus;
      localStorage.setItem('delete_status', newStatus);
      updateDeleteLabel();
    }

    deleteBtn.addEventListener('click', () => {
      if(deleteStatus === 'none'){
        showModal(
          "Are you sure you want to request account deletion?",
          `<button id='confirmDelete'>Proceed</button>
           <button id='cancelDelete'>Cancel</button>`
        );

        document.getElementById('confirmDelete').onclick = () => {
          saveDeleteStatus('pending');
          showModal("Your deletion request has been sent. Waiting for admin approval.");
        };
        document.getElementById('cancelDelete').onclick = () => modal.classList.remove('active');

      } else if(deleteStatus === 'pending'){
        showModal("Your deletion request is already pending admin approval.");
      } else if(deleteStatus === 'approved'){
        showModal("Your account is approved for deletion. Please withdraw remaining balances.");
      }
    });

    //check if the user have read the notififications
    async function checkUnreadNotifications() {
        try {
          const res = await fetch("/api/client/notifications/unread", {
            headers: { "Authorization": "Bearer " + localStorage.getItem("clientToken") }
          });

          const data = await res.json();

          const notifDot = document.getElementById("notifDot");
          notifDot.style.display = data.unread > 0 ? "inline-block" : "none";

        } catch (err) {
          console.error("Unread check failed:", err);
        }
      }

    checkUnreadNotifications();
  </script>
</body>
</html>
