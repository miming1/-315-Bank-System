<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Settings</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="header">
      <h2>BankSys</h2>
      <i class="hamburger" id="hamburger">&#9776;</i>
    </div>
    <ul>
      <li id="dashboard"><i>üè†</i> <span>Dashboard</span></li>
      <li id="history"><i>üìú</i> <span>Transaction History</span></li>
      <li id="profile"><i>‚öôÔ∏è</i> <span>Profile Settings</span></li>
      <li id="notifications">
        <i>üîî</i>
        <span style="display:flex; align-items:center; gap:8px;">
          Notifications
          <span id="notifDot" style="
            width:10px; height:10px; background:red; border-radius:50%; display:none;">
          </span>
        </span>
      </li>
      <li id="logout"><i>üö™</i> <span>Logout</span></li>
    </ul>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <button class="back-btn" id="goBack">‚Üê Back to Home</button>

    <div class="profile-card">
      <h2>Profile Settings</h2>

      <div class="profile-field">
        <label>Name:</label>
        <span id="viewName">Loading...</span>
        <input type="text" id="editName" style="display:none;">
      </div>

      <div class="profile-field">
        <label>Username:</label>
        <span id="viewEmail">Loading...</span>
        <input type="text" id="editEmail" style="display:none;">
      </div>

      <div class="profile-field">
        <label>Password:</label>
        <span id="viewPassword">********</span>
        <input type="password" id="editPassword" placeholder="Enter new password" style="display:none;">
      </div>

      <div style="display:flex; gap:10px; margin-top:15px;">
        <button id="editBtn">Edit Profile</button>
        <button id="deleteBtn" class="delete-button" style="background-color: darkred;">Delete Account</button>
      </div>

      <p id="deleteStatusLabel" style="margin-top:10px; font-size:0.9rem; color:var(--error-color);"></p>
      <div class="message" id="message"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="accountModal">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">&times;</span>
      <p id="accountMessage"></p>
      <div id="modalActions"></div>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById('sidebar');
    const sidebarItems = document.querySelectorAll('.sidebar ul li');
    sidebarItems.forEach(item => {
      const page = item.id + '.html';
      if (window.location.pathname.endsWith(page)) {
        item.style.backgroundColor = 'var(--accent-color)';
        item.style.color = '#000';
      }
    });

    const hamburger = document.getElementById('hamburger');
    hamburger.addEventListener('click', () => sidebar.classList.toggle('collapsed'));

    const clientToken = localStorage.getItem('clientToken');
    const messageDiv = document.getElementById('message');

    const viewName = document.getElementById('viewName');
    const viewEmail = document.getElementById('viewEmail');
    const viewPassword = document.getElementById('viewPassword');
    const editName = document.getElementById('editName');
    const editEmail = document.getElementById('editEmail');
    const editPassword = document.getElementById('editPassword');
    const editBtn = document.getElementById('editBtn');
    const goBack = document.getElementById('goBack');
    const deleteBtn = document.getElementById('deleteBtn');
    const deleteStatusLabel = document.getElementById('deleteStatusLabel');

    let editMode = false;
    let deleteStatus = 'none';

    function showError(msg) {
      messageDiv.textContent = msg;
      messageDiv.className = "message error";
    }

    function updateDeleteLabel() {
      if (deleteStatus === 'pending') deleteStatusLabel.textContent = "Deletion Request Pending Admin Approval";
      else if (deleteStatus === 'approved') deleteStatusLabel.textContent = "Account Approved for Deletion (Please Withdraw Balances)";
      else deleteStatusLabel.textContent = "";
    }

    function saveDeleteStatus(newStatus) {
      deleteStatus = newStatus;
      updateDeleteLabel();
    }

    function redirectToLogin(message) {
      alert(message);
      localStorage.removeItem('clientToken');
      localStorage.removeItem('clientData'); // optional: clear client info
      window.location.href = '../index.html';
    }

    async function loadProfileAndStatus() {
      if (!clientToken) return redirectToLogin("No token found. Please login again.");

      try {
        const res = await fetch('/api/client/profile/me', {
          headers: { 'Authorization': `Bearer ${clientToken}` }
        });

        if (res.status === 404) return redirectToLogin("Client not found or deleted. Redirecting to login...");

        const data = await res.json();
        if (!res.ok) return showError(data.message || "Failed to load profile.");

        // Populate profile fields
        viewName.textContent = data.full_name;
        viewEmail.textContent = data.email;
        editName.value = data.full_name;
        editEmail.value = data.email;

        // Set delete status
        if (data.status === 'pending_deletion') saveDeleteStatus('pending');
        else if (data.status === 'approved_deletion') saveDeleteStatus('approved');
        else saveDeleteStatus('none');

      } catch (err) {
        console.error(err);
        showError("Server error while fetching profile.");
      }
    }

    // Sidebar navigation
    document.getElementById('dashboard').addEventListener('click', () => window.location.href = 'home.html');
    document.getElementById('history').addEventListener('click', () => window.location.href = 'history.html');
    document.getElementById('profile').addEventListener('click', () => window.location.href = 'profile.html');
    document.getElementById('notifications').addEventListener('click', () => window.location.href = 'notifications.html');
    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('clientToken');
      window.location.href = '../index.html';
    });

    // Go back button
    goBack.addEventListener('click', () => window.location.href = 'home.html');

    // Load profile & delete status
    (async () => {
      try {
        await loadProfileAndStatus();
      } catch (err) {
        console.error("Error loading profile/status:", err);
      }
    })();

    // Edit / Save Profile
    editBtn.addEventListener('click', async () => {
      if (!editMode) {
        editMode = true;
        viewName.style.display = 'none';
        viewEmail.style.display = 'none';
        viewPassword.style.display = 'none';
        editName.style.display = 'block';
        editEmail.style.display = 'block';
        editPassword.style.display = 'block';
        editBtn.textContent = "Save Changes";
      } else {
        const payload = {
          fullName: editName.value.trim(),
          email: editEmail.value.trim()
        };
        if (editPassword.value.trim()) payload.password = editPassword.value.trim();

        try {
          const res = await fetch('/api/client/profile/me', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${clientToken}`
            },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (res.ok) {
            viewName.textContent = payload.fullName;
            viewEmail.textContent = payload.email;
            editPassword.value = '';
            const clientData = JSON.parse(localStorage.getItem('clientData')) || {};
            clientData.full_name = payload.fullName;
            clientData.email = payload.email;
            localStorage.setItem('clientData', JSON.stringify(clientData));
            editMode = false;
            viewName.style.display = 'inline';
            viewEmail.style.display = 'inline';
            viewPassword.style.display = 'inline';
            editName.style.display = 'none';
            editEmail.style.display = 'none';
            editPassword.style.display = 'none';
            editBtn.textContent = "Edit Profile";
            messageDiv.textContent = "Profile updated successfully!";
            messageDiv.className = "message success";
          } else {
            messageDiv.textContent = data.message || "Failed to update profile.";
            messageDiv.className = "message error";
          }
        } catch (err) {
          console.error(err);
          messageDiv.textContent = "Server error while updating profile.";
          messageDiv.className = "message error";
        }
      }
    });

    // DELETE ACCOUNT
    const modal = document.getElementById('accountModal');
    const modalClose = document.getElementById('modalClose');
    const accountMessage = document.getElementById('accountMessage');
    const modalActions = document.getElementById('modalActions');

    modalClose.addEventListener('click', () => modal.classList.remove('active'));
    function showModal(message, actionsHTML = '') {
      accountMessage.innerHTML = message;
      modalActions.innerHTML = actionsHTML;
      modal.classList.add('active');
    }

    deleteBtn.addEventListener('click', async () => {
      if (deleteStatus !== 'none') {
        showModal(
          deleteStatus === 'pending'
            ? "Your deletion request is already pending admin approval."
            : "Your account is approved for deletion. Please withdraw remaining balances."
        );
        return;
      }

      try {
        const res = await fetch('/api/client/accounts', {
          headers: { 'Authorization': `Bearer ${clientToken}` }
        });
        const data = await res.json();
        const hasBalance = Array.isArray(data) && data.some(acc => Number(acc.balance) > 0);

        if (hasBalance) {
          showModal("You still have remaining balances in one or more accounts. Please withdraw all balances before requesting account deletion.");
          return;
        }

        showModal(
          "Are you sure you want to request account deletion?",
          `<button id='confirmDelete'>Proceed</button>
          <button id='cancelDelete'>Cancel</button>`
        );

        document.getElementById('confirmDelete').onclick = async () => {
          try {
            const deleteRes = await fetch('/api/client/delete-request', {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${clientToken}` }
            });
            const deleteData = await deleteRes.json();
            if (deleteRes.ok) {
              saveDeleteStatus('pending');
              showModal(deleteData.message || "Your deletion request has been sent. Waiting for admin approval.");
            } else {
              showModal(deleteData.message || "Failed to request deletion.");
            }
          } catch (err) {
            console.error(err);
            showModal("Server error while requesting deletion.");
          }
        };

        document.getElementById('cancelDelete').onclick = () => modal.classList.remove('active');

      } catch (err) {
        console.error(err);
        showModal("Server error while checking account balances.");
      }
    });

    // Check unread notifications
    async function checkUnreadNotifications() {
      try {
        const res = await fetch("/api/client/notifications/unread", {
          headers: { "Authorization": `Bearer " + clientToken` }
        });
        const data = await res.json();
        const notifDot = document.getElementById("notifDot");
        notifDot.style.display = data.unread > 0 ? "inline-block" : "none";
      } catch (err) {
        console.error("Unread check failed:", err);
      }
    }

    checkUnreadNotifications();
  </script>
</body>
</html>
