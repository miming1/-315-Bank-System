<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BankSys Dashboard</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="header">
      <h2>BankSys</h2>
      <i class="hamburger" id="hamburger">&#9776;</i>
    </div>
    <ul>
      <li id="home"><i>ğŸ </i> <span>Dashboard</span></li>
      <li id="history"><i>ğŸ“œ</i> <span>Transaction History</span></li>
      <li id="profile"><i>âš™ï¸</i> <span>Profile Settings</span></li>
      <li id="notifications">
        <i>ğŸ””</i>
        <span style="display:flex; align-items:center; gap:8px;">
          Notifications
          <span id="notifDot" style="
            width:10px; height:10px; background:red; border-radius:50%; display:none;">
          </span>
        </span>
      </li>
      <li id="logout"><i>ğŸšª</i> <span>Logout</span></li>
    </ul>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="mainContent">
    <h1>Welcome, <span id="userName">User</span>!</h1>
    <h2>Your Accounts</h2>
    <div class="dashboard">
      <div class="card account-card account-open" id="deposit">
        <h3>Deposit</h3>
        <p>Your deposit account</p>
      </div>
      <div class="card account-card account-open" id="savings">
        <h3>Savings</h3>
        <p>Your savings account</p>
      </div>
      <div class="card account-card account-eligible" id="loan">
        <h3>Loan</h3>
        <p id="loanStatusText">You're not yet eligible for this account.</p>
      </div>
      <div class="card account-card account-closed" id="investment">
        <h3>Investment</h3>
        <p>Temporarily closed</p>
      </div>
      <div class="card account-card account-closed" id="health">
        <h3>Health Insurance</h3>
        <p>Temporarily closed</p>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="accountModal">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">&times;</span>
      <p id="accountMessage"></p>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.getElementById('hamburger');
    const sidebarItems = document.querySelectorAll('.sidebar ul li');
    const modal = document.getElementById('accountModal');
    const modalClose = document.getElementById('modalClose');
    const accountMessage = document.getElementById('accountMessage');

    // Sidebar toggle
    hamburger.addEventListener('click', () => sidebar.classList.toggle('collapsed'));

    // Highlight active
    sidebarItems.forEach(item => {
      const page = item.id + '.html';
      if (window.location.pathname.endsWith(page)) {
        item.style.backgroundColor = 'var(--accent-color)';
        item.style.color = '#000';
      }
    });

    const userNameSpan = document.getElementById('userName');
    const clientToken = localStorage.getItem('clientToken');

    if (clientToken) {
      fetch('/api/client/profile/me', {
        headers: { 'Authorization': `Bearer ${clientToken}` }
      })
      .then(res => res.json())
      .then(data => {
        if (data.full_name) userNameSpan.textContent = data.full_name;
        localStorage.setItem('clientData', JSON.stringify(data));
      })
      .catch(err => console.error(err));
    }

    // Sidebar navigation
    ['home','history','profile','notifications','logout'].forEach(id => {
      document.getElementById(id).addEventListener('click', () => {
        if(id === 'logout'){
          localStorage.removeItem('clientToken');
          window.location.href='../index.html';
        } else window.location.href=id+'.html';
      });
    });

    // Modal close
    modalClose.addEventListener('click', () => modal.classList.remove('active'));

    // Account click behavior
    const accounts = document.querySelectorAll('.account-card');
    accounts.forEach(card => {
      card.addEventListener('click', () => {
        const status = card.classList.contains('account-open') ? 'open' :
                      card.classList.contains('account-eligible') ? 'eligible' :
                      'closed';
        const id = card.id; // deposit, savings, loan, etc.

        // Fetch balances from localStorage
        const clientData = JSON.parse(localStorage.getItem('clientData')) || {};
        const depositBal = parseFloat(clientData.deposit_balance || 0);
        const savingsBal = parseFloat(clientData.savings_balance || 0);
        const totalBal = depositBal + savingsBal;

        if (status === 'open') {
          if (id === 'deposit') window.location.href = 'deposit.html';
          else if (id === 'savings') window.location.href = 'savings.html';
          else {
            accountMessage.textContent = `The ${card.querySelector('h3').textContent} account is temporarily closed.`;
            modal.classList.add('active');
          }
        } else if (status === 'eligible' && id === 'loan') {
          if (totalBal >= 50000) {
            // Eligible: open loan page
            window.location.href = 'loan.html';
          } else {
            // Not yet eligible: show modal with requirement
            accountMessage.innerHTML = `
              The ${card.querySelector('h3').textContent} account is not available yet.<br><br>
              Minimum total balance required (Deposit + Savings): â‚±50,000
              <br>
              <br>
              Your current total balance: â‚±${totalBal.toFixed(2)}
            `;
            modal.classList.add('active');
          }
        } else {
          accountMessage.textContent = `The ${card.querySelector('h3').textContent} account is temporarily closed.`;
          modal.classList.add('active');
        }
      });
    });

    // Optional: dynamic loan tile update (colors or red alert)
    function updateLoanTile(){
      const loanTile = document.getElementById('loan');
      const clientData = JSON.parse(localStorage.getItem('clientData')) || {};
      const totalBal = (parseFloat(clientData.deposit_balance || 0) + parseFloat(clientData.savings_balance || 0));

      if(totalBal >= 50000){
        loanTile.classList.remove('account-eligible');
        loanTile.classList.add('account-open');
        loanTile.querySelector('p').textContent = 'Your loan account';
      } else {
        loanTile.classList.add('account-eligible');
        loanTile.querySelector('p').textContent = 'You are not yet eligible for this account.';
      }
    }

    updateLoanTile();

    //check if the user have read the notififications
    async function checkUnreadNotifications() {
        try {
          const res = await fetch("/api/client/notifications/unread", {
            headers: { "Authorization": "Bearer " + localStorage.getItem("clientToken") }
          });

          const data = await res.json();

          const notifDot = document.getElementById("notifDot");
          notifDot.style.display = data.unread > 0 ? "inline-block" : "none";

        } catch (err) {
          console.error("Unread check failed:", err);
        }
      }

    checkUnreadNotifications();
  </script>
</body>
</html>
